Refactor payment processing for rollback (high-priority)
